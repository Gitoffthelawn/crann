name: crann
version: 2.0.6
description: "Effortless State Synchronization for Web Extensions"
repository: "https://github.com/moclei/crann"
license: ISC
author: "Marc O'Cleirigh"

# Project Classification
category: library
domain: web-extensions
platform: browser
language: typescript
build_system: esbuild

# Core Purpose
purpose:
  primary: "State synchronization across Web Extension contexts"
  secondary: "Eliminate manual message passing boilerplate"

# Architecture
architecture:
  pattern: "centralized-hub"
  hub_location: "service-worker"
  communication: "internal transport layer (merged from porter-source)"

# Key Features
features:
  - name: "automatic-state-sync"
    description: "Automatic synchronization between extension contexts"
  - name: "minimal-size"
    description: "< 5kb bundle size"
    constraint: "size < 5kb"
  - name: "typescript-support"
    description: "Full TypeScript support with strong type inference"
  - name: "typed-rpc-actions"
    description: "Type-safe remote procedure calls via agent.actions.*"
  - name: "state-scoping"
    description: "Shared state and agent-specific state (scope: 'shared' | 'agent')"
  - name: "persistence"
    description: "Local and session storage persistence"
  - name: "react-integration"
    description: "React hooks via crann/react"

# Dependencies
dependencies:
  runtime:
    - name: "uuid"
      version: "^13.0.0"
      type: "dependency"
      purpose: "Agent ID generation"

  development:
    - name: "typescript"
      version: "^5.5.4"
      type: "dev"
      purpose: "Primary language"
    - name: "esbuild"
      version: "^0.23.0"
      type: "dev"
      purpose: "Build system"
    - name: "jest"
      version: "^29.7.0"
      type: "dev"
      purpose: "Testing framework"
    - name: "webextension-polyfill"
      version: "^0.12.0"
      type: "dev"
      purpose: "Cross-browser compatibility"

  optional:
    - name: "react"
      version: ">=16.8.0"
      type: "peer"
      purpose: "React integration hooks"
    - name: "react-dom"
      version: ">=16.8.0"
      type: "peer"
      purpose: "React integration"

# File Structure
structure:
  source_root: "src/"
  build_output: "dist/"
  test_location: "tests/extension/"

  core_files:
    - path: "src/index.ts"
      purpose: "Public API exports"
      role: "entry-point"
    - path: "src/errors.ts"
      purpose: "Custom error classes"
      exports:
        [
          "CrannError",
          "ConfigError",
          "ActionError",
          "LifecycleError",
          "ValidationError",
        ]

  store_module:
    - path: "src/store/Store.ts"
      purpose: "Main Store class (service worker hub)"
      exports: ["Store", "createStore"]
    - path: "src/store/StateManager.ts"
      purpose: "State operations"
    - path: "src/store/Persistence.ts"
      purpose: "chrome.storage integration"
    - path: "src/store/AgentRegistry.ts"
      purpose: "Connected agent tracking"
    - path: "src/store/ActionExecutor.ts"
      purpose: "RPC action execution"
    - path: "src/store/types.ts"
      purpose: "Config schema and derived types"
      exports: ["createConfig", "Scope", "Persist"]
      key_types:
        ["ConfigSchema", "DerivedState", "DerivedActions", "ActionContext"]

  agent_module:
    - path: "src/agent/Agent.ts"
      purpose: "Client agent class"
      exports: ["Agent", "connectStore"]
    - path: "src/agent/types.ts"
      purpose: "Agent-specific types"

  react_module:
    - path: "src/react/index.ts"
      purpose: "React entry point (crann/react)"
    - path: "src/react/hooks.tsx"
      purpose: "React hooks implementation"
      exports: ["createCrannHooks"]

  transport_module:
    - path: "src/transport/"
      purpose: "Internal message passing layer (merged from porter-source)"
      note: "Not exposed in public API"

  rpc_system:
    - path: "src/rpc/adapter.ts"
      purpose: "RPC communication adapter"
    - path: "src/rpc/endpoint.ts"
      purpose: "Message endpoint implementation"
    - path: "src/rpc/types.ts"
      purpose: "RPC type definitions"

  utilities:
    - path: "src/utils/logger.ts"
      purpose: "Logging system with context awareness"
    - path: "src/utils/deepEqual.ts"
      purpose: "Deep equality checking for state changes"

  legacy_files:
    - path: "src/crann.ts"
      purpose: "Legacy v1 Crann class (deprecated)"
    - path: "src/crannAgent.ts"
      purpose: "Legacy v1 Agent (deprecated)"
    - path: "src/model/crann.model.ts"
      purpose: "Legacy v1 types (deprecated)"
    - note: "Legacy exports preserved for gradual migration, will be removed in v3"

# Build Configuration
build:
  tool: "esbuild"
  config_file: "esbuild.config.js"

  outputs:
    - format: "cjs"
      path: "dist/cjs/index.js"
      target: "node14"
    - format: "esm"
      path: "dist/esm/index.js"
      target: "es2018"
    - format: "cjs"
      path: "dist/cjs/react.js"
      target: "node14"
      entry: "crann/react"
    - format: "esm"
      path: "dist/esm/react.js"
      target: "es2018"
      entry: "crann/react"
    - format: "types"
      path: "dist/types/"

  commands:
    build_all: "npm run build"
    build_types: "npm run build:ts"
    build_js: "npm run build:js"
    build_test: "npm run build-test"
    test: "npm test"

# Package Configuration
package:
  main: "dist/cjs/index.js"
  module: "dist/esm/index.js"
  types: "dist/types/index.d.ts"
  files: ["dist"]

  exports:
    ".":
      types: "./dist/types/index.d.ts"
      require: "./dist/cjs/index.js"
      import: "./dist/esm/index.js"
    "./react":
      types: "./dist/types/react/index.d.ts"
      require: "./dist/cjs/react.js"
      import: "./dist/esm/react.js"

  keywords:
    - "web-extension"
    - "browser-extension"
    - "extension"
    - "browser"
    - "state"
    - "message"
    - "chrome"
    - "firefox"
    - "safari"
    - "edge"
    - "mv3"

# Browser Support
browsers:
  primary_testing: "chrome"
  supported:
    - name: "chrome"
      status: "tested"
    - name: "firefox"
      status: "should-work"
    - name: "safari"
      status: "should-work"
    - name: "edge"
      status: "should-work"
  manifest_version: 3
  polyfill: "webextension-polyfill"

# Extension Contexts
extension_contexts:
  hub:
    - name: "service-worker"
      role: "state-hub"
      api: "createStore(config)"

  clients:
    - name: "content-script"
      role: "client"
      api: "connectStore(config)"
    - name: "popup"
      role: "client"
      api: "connectStore(config)"
    - name: "side-panel"
      role: "client"
      api: "connectStore(config)"
    - name: "devtools"
      role: "client"
      api: "connectStore(config)"
    - name: "options-page"
      role: "client"
      api: "connectStore(config)"

# API Surface
api:
  service_worker:
    - method: "createStore(config, options?)"
      purpose: "Initialize state hub"
      returns: "Store instance"
    - method: "store.getState()"
      purpose: "Get current state"
    - method: "store.setState(partial)"
      purpose: "Update state (async)"
    - method: "store.getAgentState(agentId)"
      purpose: "Get agent-scoped state for agent"
    - method: "store.subscribe(callback)"
      purpose: "Listen to state changes"
    - method: "store.onAgentConnect(callback)"
      purpose: "Listen for new client connections"
    - method: "store.onAgentDisconnect(callback)"
      purpose: "Listen for client disconnections"
    - method: "store.getAgents(query?)"
      purpose: "Query connected agents"
    - method: "store.clear()"
      purpose: "Reset state to defaults"
    - method: "store.destroy(options?)"
      purpose: "Cleanup store resources"

  client_contexts:
    - method: "connectStore(config, options?)"
      purpose: "Connect to state hub"
      returns: "Agent instance"
    - method: "agent.ready()"
      purpose: "Returns Promise that resolves when connected"
    - method: "agent.onReady(callback)"
      purpose: "Callback when connected"
    - method: "agent.getState()"
      purpose: "Get current state"
    - method: "agent.setState(partial)"
      purpose: "Update state (async)"
    - method: "agent.subscribe(callback)"
      purpose: "Listen to state changes"
    - method: "agent.actions.*(args)"
      purpose: "Call typed RPC action"
    - method: "agent.getInfo()"
      purpose: "Get agent connection info"
    - method: "agent.onDisconnect(callback)"
      purpose: "Handle disconnection"
    - method: "agent.onReconnect(callback)"
      purpose: "Handle reconnection"
    - method: "agent.disconnect()"
      purpose: "Cleanup agent resources"

  react_hooks:
    - method: "createCrannHooks(config)"
      purpose: "Create hooks bound to config"
      returns: "{ useCrannState, useCrannActions, useCrannReady, useAgent, CrannProvider }"
    - method: "useCrannState(selector)"
      purpose: "Read state with selector"
    - method: "useCrannState(key)"
      purpose: "Read state by key, returns [value, setValue]"
    - method: "useCrannActions()"
      purpose: "Get typed action methods"
    - method: "useCrannReady()"
      purpose: "Get connection status boolean"

# State Management
state_management:
  scoping:
    - type: "shared"
      scope: "scope: 'shared'"
      description: "shared across all contexts"
      default: true
    - type: "agent"
      scope: "scope: 'agent'"
      description: "unique per agent (content script, popup, etc.)"

  persistence:
    - type: "none"
      value: "Persist.None"
      lifetime: "runtime only"
      default: true
    - type: "session"
      value: "Persist.Session"
      lifetime: "browser session"
    - type: "local"
      value: "Persist.Local"
      lifetime: "permanent until cleared"

  storage_keys:
    format: "crann:{name}:v{version}:{key}"
    metadata: "crann:{name}:__meta"

  type_support:
    - "primitive types (string, number, boolean, null)"
    - "complex objects and arrays"
    - "union types with type assertions"
    - "custom types with TypeScript inference"

# RPC System
rpc:
  purpose: "Execute functions in service worker context"

  action_definition:
    handler: "async function with (ctx, ...args)"
    context: "{ state, setState, agentId, agentLocation }"
    validate: "optional parameter validation function"

  features:
    - "type-safe parameter passing"
    - "typed return values"
    - "automatic state updates (via return or ctx.setState)"
    - "error handling and propagation"
    - "JSON-RPC 2.0 compatible protocol"

  use_cases:
    - "network requests from service worker"
    - "extension API calls requiring service worker context"
    - "complex state mutations"
    - "cross-context coordination"

# Testing
testing:
  framework: "jest"

  unit_tests:
    location: "src/**/__tests__/"
    files:
      - "StateManager.test.ts"
      - "Persistence.test.ts"
      - "AgentRegistry.test.ts"
      - "ActionExecutor.test.ts"
      - "types.test.ts"
      - "Agent.test.ts"
      - "hooks.test.tsx"
      - "integration.test.ts"

  test_extension:
    location: "tests/extension/"
    purpose: "Manual testing and integration verification"
    build_command: "npm run build-test"
    demonstrates:
      - "basic state synchronization"
      - "scoped state management"
      - "persistence options"
      - "RPC actions with validation"
      - "React integration patterns"

# Development Status
status:
  phase: "stable"
  version: "2.0.6"
  focus: "production ready"

  breaking_changes:
    - version: "2.0.0"
      description: "Major API redesign from v1"
      migration: "See README.md for migration guide"

  future_work:
    - "Storage collision detection"
    - "Enhanced schema migration testing"
    - "DevTools integration"
    - "Middleware system"
    - "Vue/Svelte integrations"

# AI Assistant Context
ai_context:
  primary_audience: ["developer", "ai-assistant"]

  key_patterns:
    - "service worker uses createStore(config), clients use connectStore(config)"
    - "config must include name (required) and optionally version"
    - "use agent.ready() or agent.onReady() before accessing state"
    - "agent.actions.* for typed RPC calls"
    - "subscribe() for reactive updates"
    - "type assertions for complex default values"

  debugging_tips:
    - "enable debug mode with { debug: true }"
    - "check console logs in both service worker and client contexts"
    - "verify connection with useCrannReady() in React"
    - "use agent.getInfo() to inspect agent metadata"

  common_gotchas:
    - "config.name is required"
    - "agent-scoped state is per-agent, not per-tab (iframes get their own)"
    - "RPC actions execute in service worker context only"
    - "persistence only applies to shared state, not agent state"
    - "always await agent.ready() before accessing state in non-React contexts"

  performance_considerations:
    - "bundle size constraint: < 5kb"
    - "transport layer uses runtime.ports for efficient messaging"
    - "deep equality checking for state change detection"
    - "React hooks optimized to minimize re-renders"
