name: crann
version: 1.0.43
description: "Effortless State Synchronization for Web Extensions"
repository: "https://github.com/moclei/crann"
license: ISC
author: "Marc O'Cleirigh"

# Project Classification
category: library
domain: web-extensions
platform: browser
language: typescript
build_system: esbuild

# Core Purpose
purpose: 
  primary: "State synchronization across Web Extension contexts"
  secondary: "Eliminate manual message passing boilerplate"
  
# Architecture
architecture:
  pattern: "centralized-hub"
  hub_location: "service-worker"
  communication: "porter-source"
  
# Key Features
features:
  - name: "automatic-state-sync"
    description: "Automatic synchronization between extension contexts"
  - name: "minimal-size"
    description: "< 5kb bundle size"
    constraint: "size < 5kb"
  - name: "typescript-support"
    description: "Full TypeScript support with strong type inference"
  - name: "rpc-actions"
    description: "Remote procedure calls executing in service worker"
  - name: "state-partitioning"
    description: "Context-specific state (instance vs service)"
  - name: "persistence"
    description: "Local and session storage persistence"
  - name: "react-integration"
    description: "React hooks for state management"

# Dependencies
dependencies:
  core:
    - name: "porter-source"
      version: "^1.1.20"
      type: "peer"
      purpose: "Message passing and agent management"
      relationship: "foundational"
      coupling: "tight"
      debug_access: ".porter-debug/"
      debug_command: "./scripts/debug-porter.sh"
      future_consideration: "potential merger under evaluation"
      
  development:
    - name: "typescript"
      version: "^5.5.4"
      type: "dev"
      purpose: "Primary language"
    - name: "esbuild"
      version: "^0.23.0" 
      type: "dev"
      purpose: "Build system"
    - name: "webextension-polyfill"
      version: "^0.12.0"
      type: "dev"
      purpose: "Cross-browser compatibility"
      
  optional:
    - name: "react"
      version: "^18.2.0"
      type: "peer"
      purpose: "React integration hooks"

# File Structure
structure:
  source_root: "src/"
  build_output: "dist/"
  test_location: "tests/extension/"
  debug_dependencies: ".porter-debug/"
  
  core_files:
    - path: "src/crann.ts"
      purpose: "Main Crann class (service worker hub)"
      exports: ["Crann", "create"]
    - path: "src/crannAgent.ts" 
      purpose: "Client connection logic"
      exports: ["connect", "connected"]
    - path: "src/index.ts"
      purpose: "Public API exports"
      role: "entry-point"
      
  type_definitions:
    - path: "src/model/crann.model.ts"
      purpose: "Core TypeScript type definitions"
      key_types: ["ConfigItem", "ActionDefinition", "DerivedState", "Partition", "Persistence"]
      
  rpc_system:
    - path: "src/rpc/adapter.ts"
      purpose: "RPC communication adapter"
    - path: "src/rpc/endpoint.ts"
      purpose: "Message endpoint implementation"
    - path: "src/rpc/types.ts"
      purpose: "RPC type definitions"
    - path: "src/rpc/memory.ts"
      purpose: "Memory management for transferred objects"
      
  utilities:
    - path: "src/utils/logger.ts"
      purpose: "Logging system with context awareness"
    - path: "src/utils/debug.ts"
      purpose: "Debug management"
    - path: "src/utils/deepEqual.ts"
      purpose: "Deep equality checking for state changes"
    - path: "src/utils/tracking.ts"
      purpose: "State change tracking"
    - path: "src/utils/agent.ts"
      purpose: "Agent utilities and tagging"
    - path: "src/utils/config.ts"
      purpose: "Configuration helpers"
      
  react_integration:
    - path: "src/hooks/useCrannState.ts"
      purpose: "React hooks for state management"
      exports: ["createCrannStateHook"]

# Build Configuration
build:
  tool: "esbuild"
  config_file: "esbuild.config.js"
  
  outputs:
    - format: "cjs"
      path: "dist/cjs/index.js"
      target: "node14"
    - format: "esm" 
      path: "dist/esm/index.js"
      target: "es2018"
    - format: "types"
      path: "dist/types/"
      
  commands:
    build_all: "npm run build"
    build_types: "npm run build:ts"
    build_js: "npm run build:js"
    build_test: "npm run build-test"
    
# Debug Tools
debug:
  porter_access:
    command: "./scripts/debug-porter.sh"
    purpose: "Access Porter-Source code for debugging cross-library issues"
    location: ".porter-debug/"
    git_ignored: true
    
  use_cases:
    - "cross-library bug investigation"
    - "message passing debugging"
    - "agent connection troubleshooting"
    - "AI context for complex issues"
    - "understanding communication layer"
    
# Package Configuration  
package:
  main: "dist/cjs/index.js"
  module: "dist/esm/index.js"
  types: "dist/types/index.d.ts"
  files: ["dist"]
  
  keywords:
    - "web-extension"
    - "browser-extension" 
    - "extension"
    - "browser"
    - "state"
    - "message"
    - "chrome"
    - "firefox"
    - "safari"
    - "edge"
    - "mv3"

# Browser Support
browsers:
  primary_testing: "chrome"
  supported:
    - name: "chrome"
      status: "tested"
    - name: "firefox"
      status: "should-work"
    - name: "safari"
      status: "should-work"
    - name: "edge"
      status: "should-work"
  manifest_version: 3
  polyfill: "webextension-polyfill"

# Extension Contexts
extension_contexts:
  hub:
    - name: "service-worker"
      role: "state-hub"
      api: "create()"
      
  clients:
    - name: "content-script"
      role: "client"
      api: "connect()"
    - name: "popup"
      role: "client" 
      api: "connect()"
    - name: "side-panel"
      role: "client"
      api: "connect()"
    - name: "devtools"
      role: "client"
      api: "connect()"
    - name: "options-page"
      role: "client"
      api: "connect()"

# API Surface
api:
  service_worker:
    - method: "create(config, options?)"
      purpose: "Initialize state hub"
      returns: "Crann instance"
    - method: "get(instanceKey?)"
      purpose: "Get current state"
    - method: "set(state, instanceKey?)"
      purpose: "Update state"
    - method: "subscribe(callback)"
      purpose: "Listen to state changes"
    - method: "onInstanceReady(callback)"
      purpose: "Listen for new client connections"
    - method: "findInstance(location)"
      purpose: "Find specific instance by location"
    - method: "queryAgents(criteria)"
      purpose: "Query connected agents"
      
  client_contexts:
    - method: "connect(config?, options?)"
      purpose: "Connect to state hub"
      returns: "Agent interface"
    - method: "get()"
      purpose: "Get current state"
    - method: "set(state)"
      purpose: "Update state"
    - method: "subscribe(callback, keys?)"
      purpose: "Listen to state changes"
    - method: "callAction(name, ...args)"
      purpose: "Execute RPC action"
    - method: "onReady(callback)"
      purpose: "Connection ready handler"

# State Management
state_management:
  partitioning:
    - type: "service"
      scope: "shared across all contexts"
      partition: "Partition.Service"
    - type: "instance"
      scope: "unique per context"
      partition: "Partition.Instance"
      
  persistence:
    - type: "none"
      persistence: "Persistence.None"
      lifetime: "runtime only"
    - type: "session"
      persistence: "Persistence.Session"
      lifetime: "browser session"
    - type: "local"
      persistence: "Persistence.Local"
      lifetime: "permanent until cleared"
      
  type_support:
    - "primitive types (string, number, boolean, null)"
    - "complex objects and arrays"
    - "union types with type assertions"
    - "custom types with TypeScript inference"

# RPC System
rpc:
  purpose: "Execute functions in service worker context"
  
  action_definition:
    handler: "async function with (state, setState, target, ...args)"
    validate: "optional parameter validation function"
    
  features:
    - "type-safe parameter passing"
    - "automatic state updates"
    - "error handling and propagation"
    - "memory management for complex objects"
    - "JSON-RPC 2.0 compatible protocol"
    
  use_cases:
    - "network requests from service worker"
    - "extension API calls requiring service worker context"
    - "complex state mutations"
    - "cross-context coordination"

# Testing
testing:
  primary_example: "tests/extension/"
  
  test_extension:
    structure:
      - "background script (service worker)"
      - "content script with UI injection"
      - "popup interface"
      - "side panel with React"
      
    demonstrates:
      - "basic state synchronization"
      - "partitioned state management"
      - "persistence options"
      - "RPC actions with validation"
      - "React integration patterns"
      - "error handling"
      
    build_command: "npm run build-test"

# Development Status
status:
  phase: "stable"
  version: "1.0.43"
  focus: "bug detection and resolution"
  priority: "stability over new features"
  
  recent_fixes:
    - issue: "nullable state types"
      description: "Fixed TypeScript inference with union types including null"
      solution: "Used infer keyword instead of property access"
      file: "src/model/crann.model.ts"
      
  known_issues: []
  
# Future Considerations
future:
  under_evaluation:
    - "porter-source integration strategy (merge vs separate)"
    - "extended browser testing"
    - "performance optimizations"
    
  ideas_location: "IDEAS.md (future)"
  
# AI Assistant Context
ai_context:
  primary_audience: ["developer", "ai-assistant"]
  
  key_patterns:
    - "service worker uses create(), clients use connect()"
    - "subscribe() for reactive updates"
    - "callAction() for service worker operations"
    - "type assertions for complex default values"
    
  debugging_tips:
    - "enable debug mode with { debug: true }"
    - "check console logs in both service worker and client contexts"
    - "verify porter-source connection status"
    - "use type inspection utilities for complex type issues"
    - "use ./scripts/debug-porter.sh for cross-library debugging"
    - "check .porter-debug/ for Porter-Source implementation details"
    
  common_gotchas:
    - "nullable types require proper union type definitions"
    - "partitioned state is context-specific"
    - "RPC actions execute in service worker context only"
    - "persistence only applies to service state, not instance state"
    
  performance_considerations:
    - "bundle size constraint: < 5kb"
    - "porter-source uses runtime.ports for performance"
    - "deep equality checking for state change detection"
